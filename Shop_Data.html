<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Salon Data Manager (Online)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ===== Global Styles ===== */
    :root {
      --bg: #f4f6f9;
      --card: #ffffff;
      --muted: #e5e7eb;
      --text: #1e293b;
      --accent: #3B82F6;
      --accent-hover: #93c5fd;
      --accent-active1: #2563EB;
      --accent-active2: #1D4ED8;
      --accent2: #10b981;
      --vip-color: #8B5CF6;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --radius: 12px;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
      --transition: all 0.25s ease-in-out;
    }

    body {
      font-family: 'Poppins', Arial, sans-serif;
      font-size: 1rem;
      line-height: 1.6;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
    }

    h1 { margin-bottom: 10px; font-size: 26px; font-weight: 700; color: #2c3e50; }
    h2 { margin-top: 20px; font-size: 1.5rem; font-weight: 600; color: #34495e; }
    h3 { font-size: 18px; margin: 25px 0 10px 0; color: #34495e; border-bottom: 2px solid var(--accent); padding-bottom: 5px; }
    h4 { font-size: 16px; margin: 20px 0 8px 0; color: #34495e; }

    /* ===== Main Navigation ===== */
    .nav { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
    .btn {
      padding: 10px 24px; font-size: 1.3rem; margin: 0; font-family: poppins; cursor: pointer; border: none;
      border-radius: 999px; background: var(--accent); color: #fff; font-weight: 500;
      transition: var(--transition); box-shadow: var(--shadow);
    }
    .btn:hover { background: var(--accent-active2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .btn.active { background: linear-gradient(135deg, var(--accent-active2), var(--accent-active2)); font-weight: 600; box-shadow: 0 0 0 3px rgba(59,130,246,0.3); }
    .btn.export-btn { background: var(--accent2); border-radius: 999px; color: #fff; margin-bottom: 0; }
    .btn.export-btn:hover { background: #059669; }
    .btn.danger-btn { background: var(--danger); font-size: 0.8em; padding: 4px 10px; }
    .btn.danger-btn:hover { background: #b91c1c; }


    /* ===== NEW Sub-Tab Navigation ===== */
    .sub-nav {
        display: flex;
        gap: 24px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        border-bottom: 2px solid var(--muted);
    }
    .sub-nav .btn {
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #64748b;
        font-size: 1rem;
        padding: 10px 4px;
        box-shadow: none;
        border-radius: 0;
        margin-bottom: -2px; /* Overlap container's border */
        font-weight: 500;
        transition: color 0.2s ease, border-color 0.2s ease;
    }
    .sub-nav .btn:hover {
        color: var(--text);
        background: transparent;
        box-shadow: none;
        transform: none;
        border-bottom-color: var(--accent-hover);
    }
    .sub-nav .btn.active {
        border-color: transparent;
        background: transparent;
        color: var(--accent-active2);
        box-shadow: none;
        font-weight: 600;
        border-bottom: 3px solid var(--accent-active2);
    }

    /* ===== Loader ===== */
    .loader-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; flex-direction: column; gap: 10px;
    }
    .loader {
        border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--accent);
        width: 60px; height: 60px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    /* ===== Tables ===== */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: var(--card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    th, td { padding: 12px 15px; text-align: left; font-size: 1rem; }
    th { background: #f1f5f9; font-weight: 600; color: #2c3e50; font-size: 15px; text-transform: uppercase; }
    tr:nth-child(even) td { background: #fafafa; }
    tr.clickable-row {
        cursor: pointer;
    }
    /* Add a transition to the cells for a smooth effect */
    tr.clickable-row td {
        transition: background-color 0.25s ease-in-out;
        position: relative; /* Required for the pseudo-element */
    }

    tr.clickable-row:hover td {
        background-color: #eff6ff;
    }

    /* Add a visual indicator on the left of the row on hover */
    tr.clickable-row:hover td:first-child::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 4px;
        background-color: var(--accent);
    }


    /* ===== Inputs ===== */
    input[type="text"], input[type="date"], input[type="month"], input[type="number"] {
      margin-bottom: 10px; padding: 8px 10px; width: 100%; border: 1px solid #ccc;
      box-sizing: border-box;
      border-radius: var(--radius); outline: none; transition: border 0.3s; font-family: inherit;
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="number"]:focus {
      border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
    }
    .header-input {
        width: 80px !important;
        padding: 4px 8px;
        font-size: 14px;
        margin: 0 5px;
        display: inline-block;
        vertical-align: middle;
    }

    /* ===== Profiles Layout ===== */
    .profiles-layout { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
    .profile-list, .profile-details {
      background: var(--card); border: 1px solid var(--muted); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 14px; height: 450px; overflow-y: auto;
    }
    .customer-item {
      display: flex; justify-content: space-between; align-items: center; padding: 10px 12px;
      border-bottom: 1px solid var(--muted); border-radius: var(--radius); cursor: pointer; transition: var(--transition);
    }
    .customer-item span.name { font-weight: 600; color: var(--text); }
    .customer-item span.phone { font-size: 13px; color: #64748b; }
    .customer-item.active { background: #dbeafe; font-weight: 600; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
    .customer-item.is-vip span.name { color: var(--vip-color); }
    .customer-item.is-vip span.name::before { content: '★ '; font-size: 0.9em; }

    /* ===== Summary Cards ===== */
    .report-summary, .staff-summary, .summary, .modal-summary {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin: 16px 0;
    }
    .report-summary .card, .staff-summary .card, .summary, .modal-summary .card {
      background: var(--card); border: 1px solid var(--muted); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 14px; text-align: center;
    }
    .report-summary .card h3, .staff-summary .card h3, .modal-summary .card h3 { font-size: 22px; margin: 6px 0; color: var(--accent-active1); }
    .report-summary .card p, .staff-summary .card p, .modal-summary .card p { margin: 0; font-size: 14px; color: #64748b; }
    .summary { font-weight: bold; }

    /* ===== Comparison Indicator ===== */
    .indicator { font-size: 0.8em; font-weight: bold; margin-left: 5px; }
    .indicator.up { color: var(--success); }
    .indicator.down { color: var(--danger); }
    .indicator.neutral { color: #64748b; }

    /* ===== Daily Revenue Chart ===== */
    .chart-container {
        display: flex; width: 100%; height: 250px; background: #f1f5f9;
        border: 1px solid var(--muted); padding: 40px 20px 0 20px;
        border-radius: var(--radius); box-shadow: var(--shadow);
        overflow-x: auto; box-sizing: border-box;
    }
    .chart-bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; text-align: center; min-width: 25px; }
    .chart-bar { width: 90%; background: linear-gradient(180deg, var(--accent-hover), var(--accent)); border-radius: 6px 6px 0 0; transition: var(--transition); position: relative; }
    .chart-bar:hover { background: linear-gradient(180deg, var(--accent-active2), var(--accent-active2)); transform: scale(1.05); }
    .chart-label { font-size: 12px; margin-top: 8px; padding-bottom: 8px; font-weight: 500; }
    .chart-tooltip {
        position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333;
        color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;
        white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s;
    }
    .chart-bar:hover .chart-tooltip { opacity: 1; visibility: visible; }

    /* ===== Staff Salary Table ===== */
    .salary-table th, .salary-table td {
        vertical-align: middle;
    }
    .salary-table .output-cell {
        font-weight: bold;
        color: var(--accent-active1);
    }
    .salary-table .total-salary {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--success);
    }
    .th-with-input {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .staff-salary-controls, #global-salary-settings {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 15px;
        background-color: var(--card);
        padding: 12px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }
    .staff-salary-controls label, #global-salary-settings label {
        margin-bottom: 0;
        font-weight: 600;
    }
    .staff-salary-controls input, #global-salary-settings input {
        margin-bottom: 0;
        width: auto;
    }

    /* ===== Customer Details Modal ===== */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000; transition: opacity 0.3s;
    }
    .modal-content {
        background: var(--bg); color: var(--text); padding: 25px;
        border-radius: var(--radius); width: 90%; max-width: 900px;
        max-height: 90vh; overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        position: relative;
    }
    .modal-close {
        position: absolute; top: 10px; right: 15px;
        background: none; border: none; font-size: 2rem;
        color: #9ca3af; cursor: pointer; line-height: 1;
    }
    .modal-close:hover { color: var(--danger); }
    .modal-content h3 { border-color: var(--accent-hover); }
    .status-tag, .renewal-tag {
        display: inline-block; padding: 4px 12px; border-radius: 999px;
        font-weight: 600; font-size: 0.9em;
    }
    .status-tag.active { background-color: #dcfce7; color: #166534; }
    .status-tag.expired { background-color: #fee2e2; color: #991b1b; }
    .renewal-tag.high { background-color: #dcfce7; color: #166534;}
    .renewal-tag.medium { background-color: #fef9c3; color: #854d0e;}
    .renewal-tag.low { background-color: #fee2e2; color: #991b1b;}
    .service-suggestion-list {
        display: flex; flex-wrap: wrap; gap: 8px; padding-left: 0; list-style-type: none;
    }
    .service-suggestion-list li {
        background-color: #e0e7ff; color: #3730a3; padding: 5px 12px; border-radius: 15px; font-size: 0.9em;
    }


    /* ===== Utility ===== */
    .hidden { display: none; }
    .controls-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    ul { list-style: none; padding: 0; }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loader" class="loader-overlay">
      <div class="loader"></div>
      <p>Fetching latest data from Google Sheet...</p>
  </div>


  <h1>Salon Data Manager</h1>

  <div class="nav">
    <button class="btn active" onclick="showTab('staff')">Staff</button>
    <button class="btn" onclick="showTab('reports')">Reports</button>
    <button class="btn" onclick="showTab('profiles')">Profiles</button>
    <button class="btn" onclick="showTab('vips')">VIPs</button>
    <button class="btn" onclick="showTab('customers')">Customers</button>
  </div>
  
  <div id="staff-tab" class="tab">
      <h2>Staff Data</h2>
       <div id="global-salary-settings">
            <label>Global Incentive per OT (₹):</label>
            <input type="number" id="global-ot-rate" style="width: 100px;">
            <label>Global Membership Incentive (₹):</label>
            <input type="number" id="global-membership-rate" style="width: 100px;">
        </div>
      <div id="staff-sub-nav" class="sub-nav">
          </div>
      <div id="staff-content">
          </div>
  </div>

  <div id="customers-tab" class="tab hidden">
    <h2>Customer Manager</h2>
    <input type="text" id="search" placeholder="Search by name or phone..." style="width: 250px;">
    <table id="customer-table"><thead><tr><th>Date</th><th>Phone</th><th>Name</th><th>Services</th><th>Staff</th><th>Member</th><th>Total ₹</th><th>Paid ₹</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="vips-tab" class="tab hidden">
    <h2>VIP Manager</h2>
    <div class="sub-nav">
        <button class="btn active" id="active-vips-btn" onclick="showVipsSubTab('active')">Active VIPs</button>
        <button class="btn" id="expired-vips-btn" onclick="showVipsSubTab('expired')">Expired VIPs</button>
    </div>
    <div id="active-vips-content">
      <input type="text" id="vip-search" placeholder="Search active VIPs..." style="width: 250px;"><div id="vip-count" class="summary"></div>
      <table id="vip-table"><thead><tr><th>Phone</th><th>Name</th><th>Join Date</th><th>Staff</th></tr></thead><tbody></tbody></table>
    </div>
    <div id="expired-vips-content" class="hidden">
      <input type="text" id="expired-vip-search" placeholder="Search expired VIPs..." style="width: 250px;"><div id="expired-vip-count" class="summary"></div>
      <table id="expired-vip-table"><thead><tr><th>Phone</th><th>Name</th><th>Join Date</th><th>Expired On</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div id="reports-tab" class="tab hidden">
    <h2>Reports</h2>
    <div class="sub-nav">
        <button class="btn active" id="monthly-summary-btn" onclick="showReportsSubTab('monthly')">Monthly Summary</button>
        <button class="btn" id="frequent-customers-btn" onclick="showReportsSubTab('frequentCustomers')">Frequent Customers</button>
        <button class="btn" id="expected-customers-btn" onclick="showReportsSubTab('expectedCustomers')">Expected Customers</button>
        <button class="btn" id="atRisk-btn" onclick="showReportsSubTab('atRisk')">At-Risk Customers</button>
    </div>
    <div id="monthly-report-content">
        <div class="controls-bar">
            <div><label for="report-month"><b>Select Month:</b></label> <input type="month" id="report-month" style="width: 250px;"></div>
            <button class="btn export-btn" id="export-contacts-btn">Export Contacts</button>
        </div>
        <div id="monthly-report-dashboard"></div>
    </div>
    <div id="frequent-customers-report-content" class="hidden">
        <div id="frequent-customers-summary" class="report-summary"></div>
        <input type="text" id="frequent-customers-search" placeholder="Search by name or phone..." style="width: 250px;">
        <table id="frequent-customers-table"><thead><tr><th>Rank</th><th>Name</th><th>Phone</th><th>Total Visits</th><th>Avg Spend</th><th>Last Visit Date</th></tr></thead><tbody></tbody></table>
    </div>
     <div id="expected-customers-report-content" class="hidden">
         <div id="expected-customers-summary" class="report-summary"></div>
         <input type="text" id="expected-customers-search" placeholder="Search by name or phone..." style="width: 250px;">
         <table id="expected-customers-table">
            <thead><tr><th>Name</th><th>Phone</th><th>Total Visits</th><th>Last Visit</th><th>Avg Days Between Visits</th><th>Expected By</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="atRisk-report-content" class="hidden">
        <div id="at-risk-summary" class="report-summary"></div>
        <input type="text" id="at-risk-search" placeholder="Search by name or phone..." style="width: 250px;">
        <table id="at-risk-table"><thead><tr><th>Name</th><th>Phone</th><th>Total Visits</th><th>Last Visit</th><th>Days Overdue</th><th>Action</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

<div id="profiles-tab" class="tab hidden">
  <h2>Customer Profiles</h2>
  <div class="sub-nav">
    <button class="btn active" onclick="showProfileTab('all')">All Customers</button>
    <button class="btn" onclick="showProfileTab('vip')">VIP Members</button>
  </div>
  <div class="profiles-layout">
    <div class="profile-list">
      <input type="text" id="profile-search" placeholder="Search customer..." style="width: 100%;"><ul id="customer-list"></ul>
    </div>
    <div class="profile-list hidden" id="vip-list-container">
      <input type="text" id="vip-profile-search" placeholder="Search VIP..." style="width: 100%;"><ul id="vip-customer-list"></ul>
    </div>
    <div class="profile-details" id="profile-details"><p>Select a customer to view profile</p></div>
  </div>
</div>

<div id="customer-details-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div id="modal-body">
            </div>
    </div>
</div>

<script>
// --- Global Data Variables ---
let entries = [];
let vip = [];
let vipPhoneSet = new Set();
let staffMembers = [];

// --- Data saved in localStorage (not from sheet) ---
let staffSalaryData = JSON.parse(localStorage.getItem("staff_salary_data") || "{}");
let globalSalarySettings = JSON.parse(localStorage.getItem("global_salary_settings") || '{"otRate": 0, "membershipRate": 0}');
let atRiskList = JSON.parse(localStorage.getItem("at_risk_list") || "{}");


// --- Google Sheet Data Fetching ---
const SPREADSHEET_ID = '1GBu3qY9OTwcornH9HJLSnsG94EoGr8Z7KDtSPdT-y58';

function buildSheetUrl(sheetName) {
    const encodedSheetName = encodeURIComponent(sheetName);
    return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodedSheetName}`;
}

/**
 * A robust CSV parser for Google Sheet data.
 * @param {string} csvText - The raw CSV string.
 * @param {Object} mapping - Maps sheet headers to object keys.
 * @param {Object} [options={}] - Additional options.
 * @param {boolean} [options.isSimpleArray=false] - If true, returns a simple array of the first column's values.
 * @param {string|null} [options.dynamicColPrefix=null] - Prefix for columns to be combined (e.g., 'service').
 * @returns {Array<Object|string>}
 */
function parseSheetData(csvText, mapping, options = {}) {
    const { isSimpleArray = false, dynamicColPrefix = null } = options;

    if (!csvText || csvText.trim().startsWith('<') || csvText.trim().startsWith('{')) {
        console.error("Invalid CSV data received.", csvText ? csvText.substring(0, 300) : "Empty response");
        return [];
    }

    const lines = csvText.trim().split(/\r?\n/);
    if (lines.length < 2) return [];

    const splitRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
    const rawHeaders = lines.shift().split(splitRegex);
    const headers = rawHeaders.map(h => h.replace(/"/g, '').trim());

    if (isSimpleArray) {
        const targetHeader = Object.keys(mapping)[0];
        const targetIndex = headers.findIndex(h => h === targetHeader);
        if (targetIndex === -1) {
            console.error(`Header "${targetHeader}" not found for simple array parsing.`);
            return [];
        }
        return lines.map(line => {
            if (!line.trim()) return null;
            const values = line.trim().split(splitRegex);
            return values[targetIndex]?.replace(/"/g, '').trim();
        }).filter(Boolean);
    }
    
    return lines.map(line => {
        if (!line.trim()) return null;
        const values = line.trim().split(splitRegex).map(v => v.replace(/^"|"$/g, '').trim());
        const obj = {};
        const dynamicValues = [];

        headers.forEach((header, index) => {
            const mappedKey = mapping[header];
            if (mappedKey) {
                obj[mappedKey] = values[index];
            } else if (dynamicColPrefix && header.toLowerCase().startsWith(dynamicColPrefix)) {
                if (values[index]) {
                    dynamicValues.push(values[index]);
                }
            }
        });

        if (dynamicColPrefix) {
            obj[dynamicColPrefix + 'Text'] = dynamicValues.join(', ');
        }
        
        return Object.values(obj).some(v => v) ? obj : null;
    }).filter(Boolean);
}


async function loadDataFromSheet() {
    const loader = document.getElementById('loader');
    loader.classList.remove('hidden');

    try {
        const entriesUrl = buildSheetUrl('Entires');
        const vipUrl = buildSheetUrl('VIP Members');
        const staffUrl = buildSheetUrl('Staff');

        // Mappings now use trimmed keys, which the robust parser will match against.
        const entriesMapping = {
            'Date': 'date', 'Phone': 'phone', 'Name': 'name',
            'Staff': 'staff', 'Member': 'member', 'Total': 'total', 'Paid ₹': 'paid'
        };
        const vipMapping = {
            'Date of Joining': 'date', 'Phone Number': 'phone',
            'Customer Name': 'name', 'Referred by': 'staff'
        };
        const staffMapping = { 'Staff Name': 'name' };
       
        const [entriesRes, vipRes, staffRes] = await Promise.all([
            fetch(entriesUrl), fetch(vipUrl), fetch(staffUrl)
        ]);

        if (!entriesRes.ok || !vipRes.ok || !staffRes.ok) {
            throw new Error('Network response was not ok.');
        }

        const [entriesText, vipText, staffText] = await Promise.all([
            entriesRes.text(), vipRes.text(), staffRes.text()
        ]);

        // Use the new universal parser for all sheets
        entries = parseSheetData(entriesText, entriesMapping, { dynamicColPrefix: 'service' });
        vip = parseSheetData(vipText, vipMapping);
        staffMembers = parseSheetData(staffText, staffMapping, { isSimpleArray: true });

        vipPhoneSet = new Set(vip.map(v => v.phone));
        
        if (entries.length === 0 && staffMembers.length === 0) {
            throw new Error("Parsing resulted in empty data. Check CSV format and sheet permissions.");
        }

    } catch (error) {
        console.error("Failed to load data from Google Sheet:", error);
        loader.innerHTML = '<p style="color:red; max-width: 400px; text-align: center;">Error loading data. <br>Please ensure the Google Sheet sharing setting is "Anyone with the link can view".</p>';
        return false; // Indicate failure
    } finally {
        if (!loader.querySelector('p[style*="color:red"]')) {
             loader.classList.add('hidden');
        }
    }
    return true; // Indicate success
}


// --- Main App Initialization ---
function initializeAllUI() {
    // Clear existing UI elements that depend on dynamic data
    document.querySelector("#customer-table tbody").innerHTML = "";
    document.querySelector("#vip-table tbody").innerHTML = "";
    document.querySelector("#expired-vip-table tbody").innerHTML = "";
    document.getElementById("staff-sub-nav").innerHTML = "";
    document.getElementById("staff-content").innerHTML = "";

    // Re-render everything with the new data
    renderCustomers();
    renderActiveVIPs();
    renderExpiredVIPs();
    setDefaultMonthAndRender();
    renderFrequentCustomersReport();
    renderExpectedCustomersReport();
    renderAtRiskReport();
    renderCustomerList();
    renderVipCustomerList();
    showProfileTab("all"); 
    renderStaffTab();
}


// --- Helper Functions ---
function parseDate(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') return new Date(0);
    // Accommodate DD-MM-YYYY or MM/DD/YYYY from sheet
    let parts;
    if (dateStr.includes('-')) {
      parts = dateStr.split('-');
      // Handles DD-MM-YYYY
      if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]); 
    } else if (dateStr.includes('/')) {
      parts = dateStr.split('/');
       // Handles MM/DD/YYYY
      if (parts.length === 3) return new Date(parts[2], parts[0] - 1, parts[1]);
    }
    // Fallback for standard date formats like YYYY-MM-DD
    const parsed = new Date(dateStr);
    return isNaN(parsed.getTime()) ? new Date(0) : parsed;
}

// Helper to get the date range for staff calculations (25th of last month to 24th of this month)
function getStaffDateRange(selectedMonth) { // "YYYY-MM"
    const [year, month] = selectedMonth.split('-').map(Number);
    // End date is the 25th of the selected month at midnight, so it includes up to the 24th.
    const endDate = new Date(year, month - 1, 25); 
    // Start date is the 25th of the previous month.
    const startDate = new Date(year, month - 2, 25);
    return { startDate, endDate };
}

function saveGlobalSettings() {
    localStorage.setItem("global_salary_settings", JSON.stringify(globalSalarySettings));
}

function getCustomerMasterSummary() {
    const customerData = {};
    entries.forEach(e => {
        if (!e.phone || e.phone === '0') return;
        if (!customerData[e.phone]) {
            customerData[e.phone] = {
                name: e.name,
                phone: e.phone,
                visitDates: new Set(),
                totalSpent: 0,
            };
        }
        const entryDate = parseDate(e.date);
        customerData[e.phone].visitDates.add(entryDate.getTime());
        customerData[e.phone].totalSpent += Number(e.paid) || 0;
        
        if (!customerData[e.phone].latestDate || entryDate > customerData[e.phone].latestDate) {
            customerData[e.phone].name = e.name;
            customerData[e.phone].latestDate = entryDate;
        }
    });

    for (const phone in customerData) {
        const sortedDates = Array.from(customerData[phone].visitDates).sort((a,b) => a - b);
        customerData[phone].totalVisits = sortedDates.length;
        customerData[phone].firstVisit = new Date(sortedDates[0]);
        customerData[phone].lastVisit = new Date(sortedDates[sortedDates.length - 1]);
        customerData[phone].avgSpend = customerData[phone].totalVisits > 0 ? (customerData[phone].totalSpent / customerData[phone].totalVisits) : 0;
    }
    return customerData;
}

function getFavoriteStaff(phone) {
    const customerHistory = entries.filter(e => e.phone === phone && e.staff);
    if (customerHistory.length === 0) return 'N/A';

    const staffCounts = customerHistory.reduce((acc, entry) => {
        acc[entry.staff] = (acc[entry.staff] || 0) + 1;
        return acc;
    }, {});

    const sortedStaff = Object.entries(staffCounts).sort((a, b) => b[1] - a[1]);

    if (sortedStaff.length === 0) return 'N/A';
    
    if (sortedStaff.length > 1 && sortedStaff[0][1] === sortedStaff[1][1]) {
        return 'Multiple';
    }
    
    return sortedStaff[0][0];
}


// ---------------- Tab Switching ----------------
function showTab(tab) {
  document.querySelectorAll(".tab").forEach(div => div.classList.add("hidden"));
  document.getElementById(tab + "-tab").classList.remove("hidden");
  
  document.querySelectorAll('.nav .btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.nav .btn[onclick="showTab('${tab}')"]`).classList.add('active');
}

// ---------------- Customers ----------------
const customerBody = document.querySelector("#customer-table tbody");
const searchInput = document.getElementById("search");
function renderCustomers(filter = "") {
  customerBody.innerHTML = "";
  const sortedEntries = [...entries].sort((a, b) => parseDate(b.date) - parseDate(a.date));
  const filtered = sortedEntries.filter(e => (e.name || "").toLowerCase().includes(filter.toLowerCase()) || (e.phone || "").toLowerCase().includes(filter.toLowerCase()));
  filtered.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${e.date || ''}</td><td>${e.phone || ''}</td><td>${e.name || ''}</td><td>${e.serviceText || ""}</td><td>${e.staff || ""}</td><td>${e.member || "Normal"}</td><td>₹${e.total || 0}</td><td>₹${e.paid || 0}</td>`;
    customerBody.appendChild(tr);
  });
}
searchInput.addEventListener("input", (e) => renderCustomers(e.target.value));

// ---------------- VIPs Tab ----------------
const oneYearAgo = new Date();
oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

function showVipsSubTab(subTabName) {
    document.querySelectorAll('#vips-tab .sub-nav .btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('active-vips-content').classList.add('hidden');
    document.getElementById('expired-vips-content').classList.add('hidden');
    
    document.getElementById(`${subTabName}-vips-content`).classList.remove('hidden');
    document.getElementById(`${subTabName}-vips-btn`).classList.add('active');
}

// Active VIPs
const vipBody = document.querySelector("#vip-table tbody");
const vipSearchInput = document.getElementById("vip-search");
const vipCountDiv = document.getElementById("vip-count");
function renderActiveVIPs(filter = "") {
  const activeVips = vip.filter(v => parseDate(v.date) >= oneYearAgo);
  vipBody.innerHTML = "";
  const filtered = activeVips.filter(v => (v.name || "").toLowerCase().includes(filter.toLowerCase()) || (v.phone || "").toLowerCase().includes(filter.toLowerCase())).sort((a, b) => parseDate(b.date) - parseDate(a.date));
  vipCountDiv.innerText = `Total Active VIPs: ${filtered.length}`;
  filtered.forEach(v => {
    const tr = document.createElement("tr");
    tr.className = 'clickable-row';
    tr.setAttribute('onclick', `showCustomerDetailsModal('${v.phone}')`);
    tr.innerHTML = `<td>${v.phone || ''}</td><td>${v.name || ''}</td><td>${v.date || ''}</td><td>${v.staff || ""}</td>`;
    vipBody.appendChild(tr);
  });
}
vipSearchInput.addEventListener("input", (e) => renderActiveVIPs(e.target.value));

// Expired VIPs
const expiredVipBody = document.querySelector("#expired-vip-table tbody");
const expiredVipSearchInput = document.getElementById("expired-vip-search");
const expiredVipCountDiv = document.getElementById("expired-vip-count");
function renderExpiredVIPs(filter = "") {
    const expiredVips = vip.filter(v => parseDate(v.date) < oneYearAgo);
    expiredVipBody.innerHTML = "";
    const filtered = expiredVips.filter(v => (v.name || "").toLowerCase().includes(filter.toLowerCase()) || (v.phone || "").toLowerCase().includes(filter.toLowerCase())).sort((a, b) => parseDate(b.date) - parseDate(a.date));
    expiredVipCountDiv.innerText = `Total Expired VIPs: ${filtered.length}`;
    filtered.forEach(v => {
        const tr = document.createElement("tr");
        const expiryDate = parseDate(v.date);
        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
        tr.className = 'clickable-row';
        tr.setAttribute('onclick', `showCustomerDetailsModal('${v.phone}')`);
        tr.innerHTML = `<td>${v.phone || ''}</td><td>${v.name || ''}</td><td>${v.date || ''}</td><td>${expiryDate.toLocaleDateString('en-GB')}</td>`;
        expiredVipBody.appendChild(tr);
    });
}
expiredVipSearchInput.addEventListener("input", (e) => renderExpiredVIPs(e.target.value));

// ---------------- Customer Details Modal ----------------
const modalOverlay = document.getElementById('customer-details-modal');
function closeModal() {
    modalOverlay.classList.add('hidden');
}

function showCustomerDetailsModal(phone) {
    const customerHistory = entries.filter(e => e.phone === phone).sort((a, b) => parseDate(b.date) - parseDate(a.date));
    const isVip = vipPhoneSet.has(phone);
    const vipRecord = isVip ? vip.find(v => v.phone === phone) : null;

    if (customerHistory.length === 0 && !vipRecord) {
        console.error("No data found for this customer phone:", phone);
        return;
    }

    const modalBody = document.getElementById('modal-body');
    const today = new Date();
    
    const customerName = vipRecord ? vipRecord.name : (customerHistory.length > 0 ? customerHistory[0].name : "Unknown");
    
    const uniqueVisitDates = new Set(customerHistory.map(e => e.date));
    const totalVisits = uniqueVisitDates.size;
    const totalSpent = customerHistory.reduce((sum, entry) => sum + (Number(entry.paid) || 0), 0);
    const avgSpend = totalVisits > 0 ? (totalSpent / totalVisits) : 0;
    const favoriteStaff = getFavoriteStaff(phone);
    const firstVisitDate = customerHistory.length > 0 ? parseDate(customerHistory[customerHistory.length - 1].date) : (vipRecord ? parseDate(vipRecord.date) : new Date());
    const totalVisitSpanDays = Math.max(1, Math.floor((today - firstVisitDate) / (1000 * 60 * 60 * 24)));
    const avgDaysBetweenVisits = totalVisits > 1 ? (totalVisitSpanDays / (totalVisits - 1)) : 0;
    const lastVisitDate = customerHistory.length > 0 ? parseDate(customerHistory[0].date) : new Date(0);
    const daysSinceLastVisit = lastVisitDate.getTime() === 0 ? 'N/A' : Math.floor((today - lastVisitDate) / (1000 * 60 * 60 * 24));
    
    let headerHTML = `<h3>${customerName} <span style="font-weight: normal; color: #64748b;">(${phone})</span></h3>`;
    let summaryCardsHTML = '';

    if (isVip && vipRecord) {
        const joinDate = parseDate(vipRecord.date);
        const expiryDate = new Date(joinDate);
        expiryDate.setFullYear(expiryDate.getFullYear() + 1);
        const isActive = expiryDate >= today;
        const status = isActive ? 'Active' : 'Expired';
        const daysRemaining = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
        const expiryText = isActive ? `Expires in ${daysRemaining} days` : `Expired ${Math.abs(daysRemaining)} days ago`;

        let renewal = { text: 'N/A', class: 'medium' };
        if (isActive && daysSinceLastVisit !== 'N/A') {
            if (daysSinceLastVisit <= 45) renewal = { text: 'High', class: 'high' };
            else if (daysSinceLastVisit <= 90) renewal = { text: 'Medium', class: 'medium' };
            else renewal = { text: 'Low', class: 'low' };
        }

        headerHTML += `
            <p>
                <span class="status-tag ${status.toLowerCase()}">${status}</span>
                <span style="margin-left: 15px;"><b>Joined:</b> ${joinDate.toLocaleDateString('en-GB')} | <b>Expiry:</b> ${expiryDate.toLocaleDateString('en-GB')} (${expiryText})</span>
                ${isActive ? `<span style="margin-left: 15px;"><b>Renewal Probability:</b> <span class="renewal-tag ${renewal.class}">${renewal.text}</span></span>` : ''}
            </p>
        `;
        summaryCardsHTML = `
            <h4>VIP Analysis</h4>
            <div class="modal-summary">
                <div class="card"><h3>₹${totalSpent.toFixed(0)}</h3><p>Total Spend</p></div>
                <div class="card"><h3>${totalVisits}</h3><p>Total Visits</p></div>
                <div class="card"><h3>₹${avgSpend.toFixed(0)}</h3><p>Avg. Spend / Visit</p></div>
                <div class="card"><h3>${avgDaysBetweenVisits.toFixed(0)} Days</h3><p>Avg. Time Between Visits</p></div>
                <div class="card"><h3>${favoriteStaff}</h3><p>Favorite Staff</p></div>
            </div>
        `;
    } else {
         headerHTML += `<p><b>Status:</b> Normal Customer</p>`;
         summaryCardsHTML = `
            <h4>Customer Analysis</h4>
            <div class="modal-summary">
                <div class="card"><h3>₹${totalSpent.toFixed(0)}</h3><p>Total Spend</p></div>
                <div class="card"><h3>${totalVisits}</h3><p>Total Visits</p></div>
                <div class="card"><h3>₹${avgSpend.toFixed(0)}</h3><p>Avg. Spend / Visit</p></div>
                <div class="card"><h3>${avgDaysBetweenVisits.toFixed(0)} Days</h3><p>Avg. Time Between Visits</p></div>
                <div class="card"><h3>${favoriteStaff}</h3><p>Favorite Staff</p></div>
            </div>
        `;
    }

    const historyHeader = daysSinceLastVisit !== 'N/A' ? `(Last Visit: ${daysSinceLastVisit} days ago)` : '';

    modalBody.innerHTML = `
        ${headerHTML}
        ${summaryCardsHTML}
        <h4>Service History ${historyHeader}</h4>
        <div style="max-height: 250px; overflow-y: auto;">
             <table>
                <thead><tr><th>Date</th><th>Services</th><th>Staff</th><th>Paid ₹</th></tr></thead>
                <tbody>
                    ${customerHistory.length > 0 ? customerHistory.map(r => `<tr><td>${r.date}</td><td>${r.serviceText || ""}</td><td>${r.staff || ""}</td><td>₹${r.paid || 0}</td></tr>`).join("") : '<tr><td colspan="4" style="text-align:center;">No service history found.</td></tr>'}
                </tbody>
            </table>
        </div>
    `;

    modalOverlay.classList.remove('hidden');
}

modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) {
        closeModal();
    }
});


// ---------------- Reports Tab ----------------
const reportMonthInput = document.getElementById("report-month");
const monthlyDashboard = document.getElementById("monthly-report-dashboard");

function showReportsSubTab(subTabName) {
    document.querySelectorAll('#reports-tab .sub-nav .btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('#monthly-report-content, #frequent-customers-report-content, #expected-customers-report-content, #atRisk-report-content').forEach(el => el.classList.add('hidden'));
    
    let contentId;
    let buttonId;

    switch (subTabName) {
        case 'monthly':
            contentId = 'monthly-report-content';
            buttonId = 'monthly-summary-btn';
            break;
        case 'frequentCustomers':
            contentId = 'frequent-customers-report-content';
            buttonId = 'frequent-customers-btn';
            renderFrequentCustomersReport(); 
            break;
        case 'expectedCustomers':
            contentId = 'expected-customers-report-content';
            buttonId = 'expected-customers-btn';
            renderExpectedCustomersReport();
            break;
        case 'atRisk':
            contentId = 'atRisk-report-content';
            buttonId = 'atRisk-btn';
            renderAtRiskReport();
            break;
    }

    if (contentId && buttonId) {
        document.getElementById(contentId).classList.remove('hidden');
        document.getElementById(buttonId).classList.add('active');
    }
}

function getMetricsForMonth(monthStr) { // Expects "YYYY-MM"
    const [year, month] = monthStr.split('-').map(Number);
    
    const monthlyEntries = entries.filter(e => {
        if (!e.date) return false;
        const entryDate = parseDate(e.date);
        return entryDate.getFullYear() === year && (entryDate.getMonth() + 1) === month;
    });

    const uniqueCustomersThisMonth = new Set(monthlyEntries.filter(e => e.phone && e.phone !== '0').map(e => e.phone));
    
    const metrics = {
        revenue: monthlyEntries.reduce((s, e) => s + (Number(e.paid) || 0), 0),
        services: monthlyEntries.length,
        uniqueCustomers: uniqueCustomersThisMonth.size,
        discounts: monthlyEntries.reduce((s, e) => {
            const discountAmount = (e.total && e.discount) ? (e.total * e.discount / 100) : ((e.total && e.paid) ? e.total - e.paid : 0);
            return s + (discountAmount > 0 ? discountAmount : 0);
        }, 0),
        newCustomers: 0
    };

    if (monthlyEntries.length > 0) {
        const monthStartDate = new Date(year, month - 1, 1);
        const previousCustomers = new Set(entries.filter(e => e.phone && e.phone !== '0' && parseDate(e.date) < monthStartDate).map(e => e.phone));
        let recurring = 0;
        uniqueCustomersThisMonth.forEach(phone => { if (previousCustomers.has(phone)) recurring++; });
        metrics.newCustomers = uniqueCustomersThisMonth.size - recurring;
    }
    return metrics;
}

function getComparisonIndicator(current, previous) {
    if (previous === 0) return current > 0 ? `<span class="indicator up">(+∞%)</span>` : `<span class="indicator neutral">(0%)</span>`;
    if (current === previous) return `<span class="indicator neutral">(0%)</span>`;
    const percentChange = ((current - previous) / previous) * 100;
    const arrow = percentChange >= 0 ? '↑' : '↓';
    const cssClass = percentChange > 0 ? 'up' : 'down';
    return `<span class="indicator ${cssClass}">(${arrow}${Math.abs(percentChange).toFixed(0)}%)</span>`;
}

function renderMonthlyReport() {
    const selectedMonth = reportMonthInput.value; // "YYYY-MM"
    if (!selectedMonth) { monthlyDashboard.innerHTML = "<p>Please select a month.</p>"; return; }

    const [year, month] = selectedMonth.split('-').map(Number);

    const monthlyEntries = entries.filter(e => {
        if (!e.date) return false;
        const entryDate = parseDate(e.date);
        return entryDate.getFullYear() === year && (entryDate.getMonth() + 1) === month;
    });
    
    if (monthlyEntries.length === 0) { monthlyDashboard.innerHTML = `<h3>No data found for ${selectedMonth}.</h3>`; return; }

    const currentMetrics = getMetricsForMonth(selectedMonth);
    const d = new Date(year, month - 1, 1);
    d.setMonth(d.getMonth() - 1);
    const prevMonthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    const prevMetrics = getMetricsForMonth(prevMonthStr);
    
    const newVipsThisMonth = vip.filter(v => {
        if (!v.date) return false;
        const vipDate = parseDate(v.date);
        return vipDate.getFullYear() === year && (vipDate.getMonth() + 1) === month;
    });
    
    const staffPerformance = {};
    monthlyEntries.forEach(e => {
        if (!e.staff) return;
        if (!staffPerformance[e.staff]) staffPerformance[e.staff] = { name: e.staff, revenue: 0, services: 0, memberships: 0 };
        staffPerformance[e.staff].revenue += (Number(e.paid) || 0);
        staffPerformance[e.staff].services++;
    });
    newVipsThisMonth.forEach(v => {
        if(v.staff && staffPerformance[v.staff]) {
          staffPerformance[v.staff].memberships++;
        } else if (v.staff) {
          staffPerformance[v.staff] = { name: v.staff, revenue: 0, services: 0, memberships: 1 };
        }
    });
    const sortedStaff = Object.values(staffPerformance).sort((a, b) => b.revenue - a.revenue);

    const serviceStats = {};
    monthlyEntries.forEach(e => {
        if (!e.serviceText) return;
        const services = e.serviceText.split(',').map(s => s.trim()).filter(Boolean);
        const revenuePerService = services.length > 0 ? (Number(e.paid) || 0) / services.length : 0;
        services.forEach(name => {
            if (!serviceStats[name]) serviceStats[name] = { name, count: 0, revenue: 0 };
            serviceStats[name].count++;
            serviceStats[name].revenue += revenuePerService;
        });
    });
    const sortedServices = Object.values(serviceStats).sort((a, b) => b.count - a.count);

    const topSpenders = Object.values(monthlyEntries.reduce((acc, e) => {
        if (e.phone && e.phone !== '0') {
            if (!acc[e.phone]) acc[e.phone] = { phone: e.phone, name: e.name, spent: 0 };
            acc[e.phone].spent += (Number(e.paid) || 0);
            acc[e.phone].name = e.name;
        }
        return acc;
    }, {})).sort((a, b) => b.spent - a.spent).slice(0, 5);

    const dailyRevenue = {};
    monthlyEntries.forEach(e => {
        const day = parseDate(e.date).getDate();
        dailyRevenue[day] = (dailyRevenue[day] || 0) + (Number(e.paid) || 0);
    });

    monthlyDashboard.innerHTML = `
      <h3>Monthly Summary</h3>
      <div class="report-summary">
        <div class="card"><h3>₹${currentMetrics.revenue.toFixed(0)}</h3><p>Total Revenue ${getComparisonIndicator(currentMetrics.revenue, prevMetrics.revenue)}</p></div>
        <div class="card"><h3>${currentMetrics.services}</h3><p>Total Services ${getComparisonIndicator(currentMetrics.services, prevMetrics.services)}</p></div>
        <div class="card"><h3>${currentMetrics.uniqueCustomers}</h3><p>Unique Customers ${getComparisonIndicator(currentMetrics.uniqueCustomers, prevMetrics.uniqueCustomers)}</p></div>
        <div class="card"><h3>${currentMetrics.newCustomers}</h3><p>New Customers ${getComparisonIndicator(currentMetrics.newCustomers, prevMetrics.newCustomers)}</p></div>
        <div class="card"><h3>₹${currentMetrics.discounts.toFixed(0)}</h3><p>Discounts Given</p></div>
        <div class="card"><h3>${newVipsThisMonth.length}</h3><p>New VIPs</p></div>
      </div>
      ${generateBarChartHTML(dailyRevenue)}
      <h3>Staff Performance</h3>
      <table><thead><tr><th>Staff Name</th><th>Revenue</th><th>Services</th><th>Memberships This Month</th></tr></thead><tbody>${sortedStaff.map(s => `<tr><td>${s.name}</td><td>₹${s.revenue.toFixed(0)}</td><td>${s.services}</td><td>${s.memberships}</td></tr>`).join("")}</tbody></table>
      <h3>Top 5 Spending Customers This Month</h3>
      <table><thead><tr><th>Name</th><th>Phone</th><th>Spent This Month</th></tr></thead><tbody>${topSpenders.map(c => `<tr class="clickable-row" onclick="showCustomerDetailsModal('${c.phone}')"><td>${c.name}</td><td>${c.phone}</td><td>₹${c.spent.toFixed(0)}</td></tr>`).join("")}</tbody></table>
      <h3>Service Popularity</h3>
      <table><thead><tr><th>Service Name</th><th>Times</th><th>Est. Revenue</th></tr></thead><tbody>${sortedServices.map(s => `<tr><td>${s.name}</td><td>${s.count}</td><td>₹${s.revenue.toFixed(0)}</td></tr>`).join("")}</tbody></table>
    `;
}

const frequentCustomersBody = document.querySelector("#frequent-customers-table tbody");
const frequentCustomersSearch = document.getElementById("frequent-customers-search");
const frequentCustomersSummary = document.getElementById("frequent-customers-summary");
function getFrequentCustomersData() {
    const customerSummary = getCustomerMasterSummary();
    return Object.values(customerSummary)
        .filter(c => c.totalVisits > 2)
        .sort((a, b) => b.totalVisits - a.totalVisits);
}
function renderFrequentCustomersReport(filter = "") {
    const frequentCustomers = getFrequentCustomersData();
    const filtered = frequentCustomers.filter(c => (c.name || '').toLowerCase().includes(filter.toLowerCase()) || (c.phone || '').includes(filter));
    frequentCustomersBody.innerHTML = "";
    
    if (frequentCustomers.length > 0) {
        const avgVisits = frequentCustomers.reduce((sum, c) => sum + c.totalVisits, 0) / frequentCustomers.length;
        const avgSpend = frequentCustomers.reduce((sum, c) => sum + c.totalSpent, 0) / frequentCustomers.length;
        frequentCustomersSummary.innerHTML = `
            <div class="card"><h3>${frequentCustomers.length}</h3><p>Total Frequent Customers</p></div>
            <div class="card"><h3>${avgVisits.toFixed(1)}</h3><p>Avg. Visits</p></div>
            <div class="card"><h3>₹${avgSpend.toFixed(0)}</h3><p>Avg. Lifetime Spend</p></div>
        `;
    } else {
        frequentCustomersSummary.innerHTML = '';
    }

    filtered.forEach((c, index) => {
        const tr = document.createElement("tr");
        tr.className = 'clickable-row';
        tr.setAttribute('onclick', `showCustomerDetailsModal('${c.phone}')`);
        tr.innerHTML = `<td>${index + 1}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.totalVisits}</td><td>₹${c.avgSpend.toFixed(0)}</td><td>${c.lastVisit.toLocaleDateString('en-GB')}</td>`;
        frequentCustomersBody.appendChild(tr);
    });
}
frequentCustomersSearch.addEventListener("input", (e) => renderFrequentCustomersReport(e.target.value));

function getVisitFrequencyData() {
    const customerSummary = getCustomerMasterSummary();
    const frequencyData = [];

    for (const phone in customerSummary) {
        const data = customerSummary[phone];
        const sortedDates = Array.from(data.visitDates).sort();
        if (sortedDates.length < 2) continue;

        const intervals = [];
        for (let i = 1; i < sortedDates.length; i++) {
            const diff = (sortedDates[i] - sortedDates[i-1]) / (1000 * 60 * 60 * 24);
            intervals.push(diff);
        }

        const avgDaysBetweenVisits = intervals.reduce((a, b) => a + b, 0) / intervals.length;
        const lastVisit = new Date(sortedDates[sortedDates.length - 1]);
        const nextExpectedVisit = new Date(lastVisit);
        nextExpectedVisit.setDate(lastVisit.getDate() + Math.round(avgDaysBetweenVisits));

        frequencyData.push({
            phone: data.phone,
            name: data.name,
            totalVisits: sortedDates.length,
            lastVisit,
            avgDaysBetweenVisits,
            nextExpectedVisit
        });
    }
    return frequencyData;
}

const expectedCustomersBody = document.querySelector("#expected-customers-table tbody");
const expectedCustomersSearch = document.getElementById("expected-customers-search");
const expectedCustomersSummary = document.getElementById("expected-customers-summary");

function renderExpectedCustomersReport(filter = "") {
    const allExpected = getExpectedCustomersData();
    const filtered = allExpected.filter(c => (c.name || '').toLowerCase().includes(filter.toLowerCase()) || (c.phone || '').includes(filter));
    
    if (allExpected.length > 0) {
        const today = new Date();
        const overdueCustomers = allExpected.filter(c => c.nextExpectedVisit < today);
        const totalOverdueDays = overdueCustomers.reduce((sum, c) => sum + (today - c.nextExpectedVisit), 0);
        const avgDaysOverdue = overdueCustomers.length > 0 ? totalOverdueDays / (1000 * 60 * 60 * 24 * overdueCustomers.length) : 0;
        expectedCustomersSummary.innerHTML = `
            <div class="card"><h3>${allExpected.length}</h3><p>Total Expected Customers</p></div>
            <div class="card"><h3>${avgDaysOverdue.toFixed(0)}</h3><p>Avg. Days Overdue</p></div>
        `;
    } else {
        expectedCustomersSummary.innerHTML = '';
    }
    
    expectedCustomersBody.innerHTML = "";
    filtered.sort((a,b) => a.nextExpectedVisit - b.nextExpectedVisit).forEach(c => {
        const tr = document.createElement("tr");
        tr.className = 'clickable-row';
        tr.setAttribute('onclick', `showCustomerDetailsModal('${c.phone}')`);
        tr.innerHTML = `<td>${c.name}</td><td>${c.phone}</td><td>${c.totalVisits}</td><td>${c.lastVisit.toLocaleDateString('en-GB')}</td><td>${c.avgDaysBetweenVisits.toFixed(0)}</td><td>${c.nextExpectedVisit.toLocaleDateString('en-GB')}</td>`;
        expectedCustomersBody.appendChild(tr);
    });
}
expectedCustomersSearch.addEventListener("input", e => renderExpectedCustomersReport(e.target.value));

function getExpectedCustomersData() {
    return getVisitFrequencyData().filter(c => !atRiskList[c.phone]);
}

const atRiskBody = document.querySelector("#at-risk-table tbody");
const atRiskSearch = document.getElementById("at-risk-search");
const atRiskSummary = document.getElementById("at-risk-summary");
function saveAtRiskList() {
    localStorage.setItem("at_risk_list", JSON.stringify(atRiskList));
}
function removeFromAtRisk(phone) {
    delete atRiskList[phone];
    saveAtRiskList();
    renderAtRiskReport();
}
function getAtRiskData() {
    const today = new Date();
    const frequencyData = getVisitFrequencyData();

    frequencyData.forEach(c => {
        const daysOverdue = (today - c.nextExpectedVisit) / (1000 * 60 * 60 * 24);
        const overdueThreshold = Math.max(c.avgDaysBetweenVisits * 0.5, 30);
        if (daysOverdue > overdueThreshold && !atRiskList[c.phone]) {
            atRiskList[c.phone] = {
                name: c.name,
                phone: c.phone,
                lastVisit: c.lastVisit.toISOString(),
                nextExpectedVisit: c.nextExpectedVisit.toISOString()
            };
        }
    });
    saveAtRiskList();

    const customerSummary = getCustomerMasterSummary();
    return Object.values(atRiskList).map(c => {
        const daysOverdue = Math.floor((today - new Date(c.nextExpectedVisit)) / (1000 * 60 * 60 * 24));
        return {
            name: c.name,
            phone: c.phone,
            totalVisits: customerSummary[c.phone]?.totalVisits || 'N/A',
            lastVisit: new Date(c.lastVisit),
            daysOverdue: daysOverdue > 0 ? daysOverdue : 0
        };
    }).sort((a,b) => b.daysOverdue - a.daysOverdue);
}

function renderAtRiskReport(filter = "") {
    const allAtRisk = getAtRiskData();
    const filtered = allAtRisk.filter(c => (c.name || '').toLowerCase().includes(filter.toLowerCase()) || (c.phone || '').includes(filter));
    
    if (allAtRisk.length > 0) {
        const avgDaysOverdue = allAtRisk.reduce((sum, c) => sum + c.daysOverdue, 0) / allAtRisk.length;
        atRiskSummary.innerHTML = `
             <div class="card"><h3>${allAtRisk.length}</h3><p>Total At-Risk Customers</p></div>
             <div class="card"><h3>${avgDaysOverdue.toFixed(0)}</h3><p>Avg. Days Overdue</p></div>
        `;
    } else {
        atRiskSummary.innerHTML = '';
    }

    atRiskBody.innerHTML = "";
    filtered.forEach(c => {
        const tr = document.createElement("tr");
        tr.className = 'clickable-row';
        tr.setAttribute('onclick', `showCustomerDetailsModal('${c.phone}')`);
        tr.innerHTML = `
            <td>${c.name}</td>
            <td>${c.phone}</td>
            <td>${c.totalVisits}</td>
            <td>${c.lastVisit.toLocaleDateString('en-GB')}</td>
            <td>${c.daysOverdue}</td>
            <td><button class="btn danger-btn" onclick="event.stopPropagation(); removeFromAtRisk('${c.phone}')">Remove</button></td>`;
        atRiskBody.appendChild(tr);
    });
}
atRiskSearch.addEventListener("input", (e) => renderAtRiskReport(e.target.value));

document.getElementById('export-contacts-btn').addEventListener('click', () => {
    const customerSummary = getCustomerMasterSummary();
    const allCustomersMap = new Map();

    for (const phone in customerSummary) {
        const c = customerSummary[phone];
        const phoneStr = String(c.phone);
        allCustomersMap.set(phoneStr, {
            Name: c.name,
            Phone: phoneStr,
            'Total Visits': c.totalVisits,
            'Last Visit': c.lastVisit ? c.lastVisit.toLocaleDateString('en-GB') : 'N/A',
            IsVIP: vipPhoneSet.has(phoneStr)
        });
    }

    vip.forEach(v => {
        const phoneStr = String(v.phone);
        if (phoneStr && !allCustomersMap.has(phoneStr)) {
            allCustomersMap.set(phoneStr, {
                Name: v.name,
                Phone: phoneStr,
                'Total Visits': 0,
                'Last Visit': 'N/A',
                IsVIP: true
            });
        }
    });

    const allCustomersList = Array.from(allCustomersMap.values());

    const vipContacts = allCustomersList.filter(c => c.IsVIP).map(({ IsVIP, ...rest }) => rest);
    const normalContacts = allCustomersList.filter(c => !c.IsVIP).map(({ IsVIP, ...rest }) => rest);

    const wb = XLSX.utils.book_new();
    if (vipContacts.length > 0) {
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(vipContacts), "VIP Customers");
    }
    if (normalContacts.length > 0) {
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(normalContacts), "Normal Customers");
    }
    
    if (wb.SheetNames.length > 0) {
        XLSX.writeFile(wb, `Salon_Contacts.xlsx`);
    }
});

function setDefaultMonthAndRender() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    reportMonthInput.value = `${yyyy}-${mm}`;
    renderMonthlyReport();
}
reportMonthInput.addEventListener('change', renderMonthlyReport);

function generateBarChartHTML(dailyData) {
    let dataPoints = Object.entries(dailyData);
    if (dataPoints.length === 0) return '';
    dataPoints.sort((a, b) => a[0].localeCompare(b[0], undefined, { numeric: true }));
    const maxRevenue = Math.max(...dataPoints.map(d => d[1]));
    return `<h3>Daily Revenue Trend</h3><div class="chart-container">${dataPoints.map(([day, revenue]) => {
        const height = maxRevenue > 0 ? (revenue / maxRevenue) * 100 : 0;
        return `<div class="chart-bar-wrapper"><div class="chart-bar" style="height: ${height}%;"><div class="chart-tooltip">₹${revenue.toFixed(0)}</div></div><div class="chart-label">${day}</div></div>`;
    }).join('')}</div>`;
}

// ---------------- Profiles ----------------
const customerList = document.querySelector("#customer-list");
const vipCustomerList = document.querySelector("#vip-customer-list");
const profileDetails = document.getElementById("profile-details");
const profileSearch = document.getElementById("profile-search");
const vipProfileSearch = document.getElementById("vip-profile-search");
const vipListContainer = document.getElementById("vip-list-container");
let activeProfilePhone = null;

function getUniqueCustomers() {
  const map = {};
  entries.forEach(e => {
    if (!e.phone || e.phone === "0") return;
    if (!map[e.phone]) map[e.phone] = { phone: e.phone, name: e.name || "", isVip: vipPhoneSet.has(e.phone) };
  });
  return Object.values(map);
}
function showProfileTab(type) {
  document.querySelectorAll('#profiles-tab .profile-list').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('#profiles-tab .sub-nav .btn').forEach(el => el.classList.remove('active'));
    if (type === 'all') {
        customerList.parentElement.classList.remove('hidden');
        document.querySelector('#profiles-tab .sub-nav .btn[onclick="showProfileTab(\'all\')"]').classList.add('active');
    } else {
        vipListContainer.classList.remove('hidden');
        document.querySelector('#profiles-tab .sub-nav .btn[onclick="showProfileTab(\'vip\')"]').classList.add('active');
    }
    profileDetails.innerHTML = "<p>Select a customer to view profile</p>";
    activeProfilePhone = null;
    highlightActiveProfile();
}
function renderCustomerList(filter = "") {
  customerList.innerHTML = "";
  const customers = getUniqueCustomers().filter(c => (c.phone || '').includes(filter) || (c.name || "").toLowerCase().includes(filter.toLowerCase()));
  customers.forEach(c => {
    const li = document.createElement("li");
    li.className = "customer-item";
    if (c.isVip) li.classList.add('is-vip');
    li.dataset.phone = c.phone;
    li.innerHTML = `<span class="name">${c.name || "Unknown"}</span><span class="phone">${c.phone}</span>`;
    li.addEventListener("click", () => showProfile(c.phone));
    customerList.appendChild(li);
  });
  highlightActiveProfile();
}
function renderVipCustomerList(filter = "") {
  vipCustomerList.innerHTML = "";
  const vipOnly = vip.filter(v => v.phone && v.phone !== "0" && ((v.name || "").toLowerCase().includes(filter.toLowerCase()) || (v.phone || "").includes(filter)));
  vipOnly.forEach(v => {
    const li = document.createElement("li");
    li.className = "customer-item is-vip";
    li.dataset.phone = v.phone;
    li.innerHTML = `<span class="name">${v.name || "Unknown"}</span><span class="phone">${v.phone}</span>`;
    li.addEventListener("click", () => showProfile(v.phone));
    vipCustomerList.appendChild(li);
  });
  highlightActiveProfile();
}
function highlightActiveProfile() {
    document.querySelectorAll('#profiles-tab .customer-item').forEach(li => {
        if(li.dataset.phone === activeProfilePhone) li.classList.add('active');
        else li.classList.remove('active');
    });
}
function showProfile(phone) {
  activeProfilePhone = phone;
  highlightActiveProfile();
  const records = entries.filter(e => e.phone === phone).sort((a,b) => parseDate(b.date) - parseDate(a.date));
  if (records.length === 0) { profileDetails.innerHTML = "<p>No records found.</p>"; return; }
  
  const customer = records[0];
  const totalSpent = records.reduce((a, r) => a + (Number(r.paid) || 0), 0);
  const isVip = vipPhoneSet.has(phone);
  const favoriteStaff = getFavoriteStaff(phone);
  
  const uniqueVisitDates = new Set(records.map(r => r.date));
  const totalVisits = uniqueVisitDates.size;
  
  profileDetails.innerHTML = `
    <h3>${customer.name} (${customer.phone})</h3>
    <p><b>Member:</b> ${isVip ? "🌟 VIP Member" : (customer.member || "Normal")}</p>
    <p><b>Total Visits:</b> ${totalVisits}</p>
    <p><b>Total Spent:</b> ₹${totalSpent.toFixed(0)}</p>
    <p><b>Favorite Staff:</b> ${favoriteStaff}</p>
    <h4>Service History:</h4>
    <table><thead><tr><th>Date</th><th>Services</th><th>Staff</th><th>Paid ₹</th></tr></thead><tbody>${records.map(r => `<tr><td>${r.date}</td><td>${r.serviceText || ""}</td><td>${r.staff || ""}</td><td>₹${r.paid || 0}</td></tr>`).join("")}</tbody></table>`;
}
profileSearch.addEventListener("input", (e) => renderCustomerList(e.target.value));
vipProfileSearch.addEventListener("input", (e) => renderVipCustomerList(e.target.value));

// ---------------- Staff Salary Calculator ----------------
const staffSubNav = document.getElementById('staff-sub-nav');
const staffContent = document.getElementById('staff-content');
let activeStaffName = null;

function saveBaseSalary(staffName, value) {
    if (!staffSalaryData[staffName]) {
        staffSalaryData[staffName] = { baseSalary: 0, monthlyData: {} };
    }
    staffSalaryData[staffName].baseSalary = value;
    localStorage.setItem("staff_salary_data", JSON.stringify(staffSalaryData));
}

function saveMonthlySalaryData(staffName, month, key, value) {
    if (!staffSalaryData[staffName]) {
        staffSalaryData[staffName] = { baseSalary: 0, monthlyData: {} };
    }
    if (!staffSalaryData[staffName].monthlyData) {
         staffSalaryData[staffName].monthlyData = {};
    }
    if (!staffSalaryData[staffName].monthlyData[month]) {
        staffSalaryData[staffName].monthlyData[month] = {};
    }
    staffSalaryData[staffName].monthlyData[month][key] = value;
    localStorage.setItem("staff_salary_data", JSON.stringify(staffSalaryData));
}

function showStaffSubTab(staffName) {
    activeStaffName = staffName;
    document.querySelectorAll('#staff-sub-nav .btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`#staff-sub-nav .btn[data-staff="${staffName}"]`).classList.add('active');
    document.querySelectorAll('.staff-salary-content').forEach(div => div.classList.add('hidden'));
    document.getElementById(`staff-content-${staffName}`).classList.remove('hidden');
}

function showStaffDetailsSubTab(staffName, tabToShow) {
    const staffDetailsContainer = document.getElementById(`staff-details-${staffName}`);
    if (!staffDetailsContainer) return;

    staffDetailsContainer.querySelectorAll('.staff-details-content').forEach(div => div.classList.add('hidden'));
    staffDetailsContainer.querySelectorAll('.sub-nav .btn').forEach(btn => btn.classList.remove('active'));

    document.getElementById(`staff-details-${tabToShow}-${staffName}`).classList.remove('hidden');
    staffDetailsContainer.querySelector(`.sub-nav .btn[onclick*="'${tabToShow}'"]`).classList.add('active');
}

function calculateSalary(staffName, selectedMonth) {
    const staffDiv = document.getElementById(`staff-content-${staffName}`);
    if (!staffDiv || !selectedMonth) return;

    const monthData = staffSalaryData[staffName]?.monthlyData?.[selectedMonth] || {};
    const ots = parseFloat(monthData.ots) || 0;
    const extraDays = parseFloat(monthData.extraDays) || 0;
    const percentIncentive = parseFloat(monthData.percentIncentive) || 0;

    const { startDate, endDate } = getStaffDateRange(selectedMonth);
    const records = entries.filter(e => {
        if (!e.staff || e.staff !== staffName || !e.date) return false;
        const entryDate = parseDate(e.date);
        return entryDate >= startDate && entryDate < endDate;
    });
    const totalRevenueMonth = records.reduce((a, r) => a + (Number(r.paid) || 0), 0);

    const baseSalary = parseFloat(staffSalaryData[staffName]?.baseSalary) || 0;
    const memberships = parseFloat(staffDiv.querySelector('.memberships-count').textContent) || 0;

    const otIncentiveRate = globalSalarySettings.otRate || 0;
    const membershipIncentiveRate = globalSalarySettings.membershipRate || 0;

    const otIncentiveTotal = ots * otIncentiveRate;
    const percentIncentiveTotal = totalRevenueMonth * (percentIncentive / 100);
    const extraDayPay = (baseSalary / 30) * extraDays;
    const membershipIncentiveTotal = memberships * membershipIncentiveRate;

    const totalSalary = baseSalary + otIncentiveTotal + percentIncentiveTotal + extraDayPay + membershipIncentiveTotal;

    staffDiv.querySelector('.ot-incentive-total').textContent = `₹${otIncentiveTotal.toFixed(2)}`;
    staffDiv.querySelector('.percent-incentive-total').textContent = `₹${percentIncentiveTotal.toFixed(2)}`;
    staffDiv.querySelector('.extra-day-pay').textContent = `₹${extraDayPay.toFixed(2)}`;
    staffDiv.querySelector('.membership-incentive-total').textContent = `₹${membershipIncentiveTotal.toFixed(2)}`;
    staffDiv.querySelector('.total-salary').textContent = `₹${totalSalary.toFixed(2)}`;
}


function updateSalaryInputsAndRecalculate(staffName, selectedMonth) {
    const staffDiv = document.getElementById(`staff-content-${staffName}`);
    if (!staffDiv || !selectedMonth) return;

    const monthData = staffSalaryData[staffName]?.monthlyData?.[selectedMonth] || {};
    staffDiv.querySelector('.ots').value = monthData.ots || '';
    staffDiv.querySelector('.extra-days').value = monthData.extraDays || '';
    staffDiv.querySelector('.percent-incentive').value = monthData.percentIncentive || 0;

    updateStaffMonthlyData(staffName, selectedMonth);
}

function updateStaffMonthlyData(staffName, selectedMonth) {
    const staffDiv = document.getElementById(`staff-content-${staffName}`);
    if (!staffDiv || !selectedMonth) return;
    
    const { startDate, endDate } = getStaffDateRange(selectedMonth);

    const newVipsThisMonth = vip.filter(v => {
        if (!v.date || v.staff !== staffName) return false;
        const vipDate = parseDate(v.date);
        return vipDate >= startDate && vipDate < endDate;
    });
    const membershipCount = newVipsThisMonth.length;
    staffDiv.querySelector('.memberships-count').textContent = membershipCount;
    
    calculateSalary(staffName, selectedMonth); 
    renderStaffMonthlyDetails(staffName, selectedMonth);
}

function renderStaffMonthlyDetails(staffName, selectedMonth) {
    const summaryContainer = document.getElementById(`staff-summary-${staffName}`);
    const servicesContainer = document.getElementById(`staff-details-services-${staffName}`);
    if(!summaryContainer || !servicesContainer) return;

    const { startDate, endDate } = getStaffDateRange(selectedMonth);

    const records = entries.filter(e => {
        if (!e.staff || e.staff !== staffName || !e.date) return false;
        const entryDate = parseDate(e.date);
        return entryDate >= startDate && entryDate < endDate;
    });

    const vipsThisMonth = vip.filter(v => {
        if (!v.staff || v.staff !== staffName || !e.date) return false;
        const vipDate = parseDate(v.date);
        return vipDate >= startDate && vipDate < endDate;
    });
    
    const totalRevenueMonth = records.reduce((a, r) => a + (Number(r.paid) || 0), 0);
    const servicesMonth = records.length;
    const membershipsMonth = vipsThisMonth.length;
    const membershipsTotal = vip.filter(v => v.staff === staffName).length;

    summaryContainer.innerHTML = `
        <div class="card"><h3>₹${totalRevenueMonth.toFixed(0)}</h3><p>Revenue This Month</p></div>
        <div class="card"><h3>${servicesMonth}</h3><p>Services This Month</p></div>
        <div class="card"><h3>${membershipsMonth}</h3><p>New VIPs This Month</p></div>
        <div class="card"><h3>${membershipsTotal}</h3><p>Total VIPs (All Time)</p></div>
    `;

    const servicesTableHTML = records.length > 0 ?
        records.sort((a,b) => parseDate(b.date) - parseDate(a.date)).map(r => `<tr class="clickable-row" onclick="showCustomerDetailsModal('${r.phone}')"><td>${r.date}</td><td>${r.name} (${r.phone})</td><td>${r.serviceText || ""}</td><td>₹${r.paid || 0}</td></tr>`).join("") :
        '<tr><td colspan="4" style="text-align:center;">No services recorded for this month.</td></tr>';

    servicesContainer.innerHTML = `
        <h3>Service Records for ${selectedMonth}</h3>
        <table>
            <thead><tr><th>Date</th><th>Customer</th><th>Services</th><th>Paid ₹</th></tr></thead>
            <tbody>${servicesTableHTML}</tbody>
        </table>
    `;
}

function renderStaffAllTimeMemberships(staffName) {
    const membershipsContainer = document.getElementById(`staff-details-memberships-${staffName}`);
    if (!membershipsContainer) return;

    const allTimeVipsByStaff = vip.filter(v => v.staff === staffName)
                                 .sort((a,b) => parseDate(b.date) - parseDate(a.date));

    const membershipsTableHTML = allTimeVipsByStaff.length > 0 ?
        allTimeVipsByStaff.map(v => `<tr class="clickable-row" onclick="showCustomerDetailsModal('${v.phone}')"><td>${v.date}</td><td>${v.name}</td><td>${v.phone}</td></tr>`).join("") :
        '<tr><td colspan="3" style="text-align:center;">No membership signups recorded.</td></tr>';

    membershipsContainer.innerHTML = `
        <h3>All-Time Membership Signups</h3>
        <table>
            <thead><tr><th>Join Date</th><th>Customer Name</th><th>Phone</th></tr></thead>
            <tbody>${membershipsTableHTML}</tbody>
        </table>
    `;
}

function renderStaffFrequentCustomers(staffName) {
    const container = document.getElementById(`staff-details-frequent-${staffName}`);
    if (!container) return;

    const staffEntries = entries.filter(e => e.staff === staffName && e.phone && e.phone !== '0');
    
    const customerVisits = staffEntries.reduce((acc, entry) => {
        if (!acc[entry.phone]) {
            acc[entry.phone] = { name: entry.name, phone: entry.phone, visits: 0 };
        }
        acc[entry.phone].visits++;
        acc[entry.phone].name = entry.name;
        return acc;
    }, {});

    const frequentCustomers = Object.values(customerVisits)
        .filter(c => c.visits > 2)
        .sort((a, b) => b.visits - a.visits);

    let summaryHTML = '';
    if (frequentCustomers.length > 0) {
        const avgVisits = frequentCustomers.reduce((sum, c) => sum + c.visits, 0) / frequentCustomers.length;
        summaryHTML = `
            <div class="report-summary" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                <div class="card"><h3>${frequentCustomers.length}</h3><p>Total Frequent Customers</p></div>
                <div class="card"><h3>${avgVisits.toFixed(1)}</h3><p>Avg. Visits (with you)</p></div>
            </div>`;
    }

    const tableHTML = frequentCustomers.length > 0 ?
        frequentCustomers.map((c, index) => `<tr class="clickable-row" onclick="showCustomerDetailsModal('${c.phone}')"><td>${index + 1}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.visits}</td></tr>`).join('') :
        '<tr><td colspan="4" style="text-align:center;">No frequent customers found.</td></tr>';

    container.innerHTML = `
        <h3>Frequent Customers for ${staffName}</h3>
        ${summaryHTML}
        <table>
            <thead><tr><th>Rank</th><th>Name</th><th>Phone</th><th>Visits (with this staff)</th></tr></thead>
            <tbody>${tableHTML}</tbody>
        </table>
    `;
}

function renderStaffTab() {
    if (staffMembers.length === 0) {
        staffSubNav.innerHTML = "<p>No staff members found in the Google Sheet.</p>";
        return;
    }

    staffSubNav.innerHTML = '';
    staffContent.innerHTML = '';
    activeStaffName = staffMembers[0];

    staffMembers.forEach((name, index) => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = name;
        btn.dataset.staff = name;
        if (index === 0) btn.classList.add('active');
        btn.onclick = () => showStaffSubTab(name);
        staffSubNav.appendChild(btn);
        
        const staffData = staffSalaryData[name] || { baseSalary: 0, monthlyData: {} };

        const contentDiv = document.createElement('div');
        contentDiv.id = `staff-content-${name}`;
        contentDiv.className = 'staff-salary-content';
        if (index !== 0) contentDiv.classList.add('hidden');
        contentDiv.innerHTML = `
            <div class="staff-salary-controls">
                <label for="salary-month-${name}"><b>Select Month:</b></label>
                <input type="month" id="salary-month-${name}" class="salary-month">
            </div>
            <table class="salary-table">
                <thead>
                    <tr>
                        <th>Base Salary</th>
                        <th>No. of OTs</th>
                        <th>OT Incentive</th>
                        <th class="th-with-input">% Incentive <input type="number" class="header-input percent-incentive"></th>
                        <th>Extra Days</th>
                        <th>Extra Day Pay</th>
                        <th>Memberships</th>
                        <th>Membership Incentive</th>
                        <th>Total Salary</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" class="base-salary" placeholder="0" value="${staffData.baseSalary || ''}"></td>
                        <td><input type="number" class="ots" placeholder="0"></td>
                        <td class="output-cell ot-incentive-total">₹0.00</td>
                        <td class="output-cell percent-incentive-total">₹0.00</td>
                        <td><input type="number" class="extra-days" placeholder="0"></td>
                        <td class="output-cell extra-day-pay">₹0.00</td>
                        <td class="output-cell memberships-count">0</td>
                        <td class="output-cell membership-incentive-total">₹0.00</td>
                        <td class="output-cell total-salary">₹0.00</td>
                    </tr>
                </tbody>
            </table>
            <div class="staff-performance-details" id="staff-details-${name}">
                <div class="staff-summary" id="staff-summary-${name}" style="margin-top: 25px;"></div>
                <div class="sub-nav" style="margin-top: 20px;">
                    <button class="btn active" onclick="showStaffDetailsSubTab('${name}', 'memberships')">Memberships</button>
                    <button class="btn" onclick="showStaffDetailsSubTab('${name}', 'services')">Services This Month</button>
                    <button class="btn" onclick="showStaffDetailsSubTab('${name}', 'frequent')">Frequent Customers</button>
                </div>
                <div id="staff-details-memberships-${name}" class="staff-details-content"></div>
                <div id="staff-details-services-${name}" class="staff-details-content hidden"></div>
                <div id="staff-details-frequent-${name}" class="staff-details-content hidden"></div>
            </div>
        `;
        staffContent.appendChild(contentDiv);
        
        const staffDiv = document.getElementById(`staff-content-${name}`);
        const salaryMonthInput = staffDiv.querySelector('.salary-month');
        const otsInput = staffDiv.querySelector('.ots');
        const extraDaysInput = staffDiv.querySelector('.extra-days');
        const percentIncentiveInput = staffDiv.querySelector('.percent-incentive');
        const baseSalaryInput = staffDiv.querySelector('.base-salary');

        salaryMonthInput.addEventListener('change', () => {
             updateSalaryInputsAndRecalculate(name, salaryMonthInput.value);
        });

        baseSalaryInput.addEventListener('input', (e) => {
            saveBaseSalary(name, parseFloat(e.target.value) || 0);
            calculateSalary(name, salaryMonthInput.value);
        });
        
        [otsInput, extraDaysInput, percentIncentiveInput].forEach(input => {
            input.addEventListener('input', (e) => {
                const key = e.target.classList.contains('ots') ? 'ots' :
                              e.target.classList.contains('extra-days') ? 'extraDays' : 'percentIncentive';
                saveMonthlySalaryData(name, salaryMonthInput.value, key, parseFloat(e.target.value) || 0);
                calculateSalary(name, salaryMonthInput.value);
            });
        });

        renderStaffAllTimeMemberships(name);
        renderStaffFrequentCustomers(name);

        const today = new Date();
        salaryMonthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        salaryMonthInput.dispatchEvent(new Event('change'));
    });
}


// --- Initial Load & Polling ---
document.addEventListener('DOMContentLoaded', async () => {
    // Initial static listeners
    const globalOtInput = document.getElementById('global-ot-rate');
    const globalMembershipInput = document.getElementById('global-membership-rate');
    globalOtInput.value = globalSalarySettings.otRate || 0;
    globalMembershipInput.value = globalSalarySettings.membershipRate || 0;

    globalOtInput.addEventListener('input', (e) => {
        globalSalarySettings.otRate = parseFloat(e.target.value) || 0;
        saveGlobalSettings();
        if (activeStaffName) {
            const staffDiv = document.getElementById(`staff-content-${activeStaffName}`);
            const selectedMonth = staffDiv.querySelector('.salary-month').value;
            calculateSalary(activeStaffName, selectedMonth);
        }
    });
    globalMembershipInput.addEventListener('input', (e) => {
        globalSalarySettings.membershipRate = parseFloat(e.target.value) || 0;
        saveGlobalSettings();
        if (activeStaffName) {
            const staffDiv = document.getElementById(`staff-content-${activeStaffName}`);
            const selectedMonth = staffDiv.querySelector('.salary-month').value;
            calculateSalary(activeStaffName, selectedMonth);
        }
    });

    // First data load
    const success = await loadDataFromSheet();
    
    // Only initialize UI and polling if the first load is successful
    if (success) {
        showTab('staff');
        initializeAllUI();

        // Set up polling to refresh data every 5 minutes
        setInterval(async () => {
            console.log("Refreshing data from Google Sheet...");
            const refreshSuccess = await loadDataFromSheet();
            if(refreshSuccess) {
              initializeAllUI();
            }
        }, 300000); // 300000 ms = 5 minutes
    }
});

</script>

</body>
</html>

